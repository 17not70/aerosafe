{
  "entities": {
    "Report": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Report",
      "type": "object",
      "description": "Represents a safety report, either voluntary (VSR) or mandatory (MOR).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the report."
        },
        "type": {
          "type": "string",
          "description": "Type of the report (VSR or MOR)."
        },
        "title": {
          "type": "string",
          "description": "Title of the report."
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the safety event."
        },
        "severity": {
          "type": "number",
          "description": "Severity of the safety event (e.g., on a scale of 1-5)."
        },
        "probability": {
          "type": "number",
          "description": "Probability of the safety event occurring again (e.g., on a scale of 1-5)."
        },
        "riskIndex": {
          "type": "number",
          "description": "Calculated risk index (Severity x Probability)."
        },
        "actionStatus": {
          "type": "string",
          "description": "Current status of corrective actions (e.g., Open, In Progress, Closed)."
        },
        "attachments": {
          "type": "array",
          "description": "References to attachments stored in Cloud Storage.",
          "items": {
            "type": "string"
          }
        },
        "reporterId": {
          "type": "string",
          "description": "Reference to User who submitted the report. (Relationship: User 1:N Report)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the report was created.",
          "format": "date-time"
        },
        "hazardType": {
          "type": "string",
          "description": "Category of the hazard reported."
        }
      },
      "required": [
        "id",
        "type",
        "title",
        "description",
        "severity",
        "probability",
        "riskIndex",
        "actionStatus",
        "reporterId",
        "createdAt",
        "hazardType"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the AeroSafe Insights application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "name": {
          "type": "string",
          "description": "Full name of the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "Role of the user (Reporter, Safety Officer, Admin)."
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "role"
      ]
    },
    "CorrectiveAction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CorrectiveAction",
      "type": "object",
      "description": "Represents a corrective or preventative action taken in response to a safety report.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the corrective action."
        },
        "reportId": {
          "type": "string",
          "description": "Reference to the Report this action is associated with. (Relationship: Report 1:N CorrectiveAction)"
        },
        "assignedTo": {
          "type": "string",
          "description": "Reference to User assigned to this action. (Relationship: User 1:N CorrectiveAction)"
        },
        "description": {
          "type": "string",
          "description": "Description of the corrective action."
        },
        "dueDate": {
          "type": "string",
          "description": "Date by which the action should be completed.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Current status of the action (e.g., Open, In Progress, Closed)."
        }
      },
      "required": [
        "id",
        "reportId",
        "assignedTo",
        "description",
        "dueDate",
        "status"
      ]
    },
    "AuditLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AuditLog",
      "type": "object",
      "description": "Represents an audit log entry for tracking user actions.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the audit log entry."
        },
        "actorId": {
          "type": "string",
          "description": "Reference to User who performed the action. (Relationship: User 1:N AuditLog)"
        },
        "action": {
          "type": "string",
          "description": "Description of the action performed (e.g., 'Report submitted', 'User updated')."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the action was performed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "actorId",
        "action",
        "timestamp"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. 'userId' is the Firebase Auth UID.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/reports/{reportId}",
        "definition": {
          "entityName": "Report",
          "schema": {
            "$ref": "#/backend/entities/Report"
          },
          "description": "Stores safety reports submitted by a specific user. 'userId' matches the report's 'reporterId'.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who submitted the report."
            },
            {
              "name": "reportId",
              "description": "The unique ID of the report."
            }
          ]
        }
      },
      {
        "path": "/corrective_actions/{correctiveActionId}",
        "definition": {
          "entityName": "CorrectiveAction",
          "schema": {
            "$ref": "#/backend/entities/CorrectiveAction"
          },
          "description": "Stores corrective actions related to safety reports. Authorization Independence achieved via denormalization.",
          "params": [
            {
              "name": "correctiveActionId",
              "description": "The unique ID of the corrective action."
            }
          ]
        }
      },
      {
        "path": "/audit_logs/{auditLogId}",
        "definition": {
          "entityName": "AuditLog",
          "schema": {
            "$ref": "#/backend/entities/AuditLog"
          },
          "description": "Stores audit logs of user actions. Only accessible to admins.",
          "params": [
            {
              "name": "auditLogId",
              "description": "The unique ID of the audit log entry."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store UIDs of admin users. Existence in this collection grants admin privileges.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the admin user."
            }
          ]
        }
      },
      {
        "path": "/roles_safety_officer/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store UIDs of safety officer users. Existence in this collection grants safety officer privileges.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the safety officer user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the AeroSafe Insights application, focusing on role-based access control, efficient data retrieval, and scalability. It incorporates denormalization to ensure Authorization Independence, which is critical for security and atomic operations. The structure uses structural segregation to enforce homogeneous security postures within collections.\n\n*   **Users Collection:** Stores user profiles, including roles.  Security rules will ensure only admins can create/modify user roles.\n*   **Reports Collection:** Stores safety reports. Reporters can only read/write their own reports, while Safety Officers and Admins have broader access.\n*   **Corrective Actions Collection:** Stores corrective actions related to reports.  The `reportId` field links actions to reports. Authorization Independence is achieved via denormalization of report access rights to enable atomic operations on corrective actions linked to reports.\n*   **Audit Logs Collection:** Logs user actions for auditing purposes.  Only Admins can read this collection.\n*   **Roles Collections:** Admin and Safety Officer roles are stored in dedicated collections. These collections use Existence over Content for rule definitions to determine global roles. This approach simplifies security rules and enhances maintainability.\n\n**Authorization Independence:**  Corrective Actions and Reports are directly related to their parent objects via IDs.  This removes authorization dependencies in rules and enables atomic creation/updates/deletes.\n\n**QAPs (Rules are not Filters):**\n\n*   The separation of data into collections based on access roles enables efficient and secure list operations.  For example, `/users/{userId}/reports` allows reporters to list only their own reports without requiring filtering in the rules.\n*   The use of existence checks in the `roles_admin` and `roles_safety_officer` collections allows for QAPs, as it avoids reading the user document to check the role, improving performance and security."
  }
}