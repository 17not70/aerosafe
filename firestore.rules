/**
 * @fileOverview Firestore Security Rules for AeroSafe Insights.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, granting specific privileges based on a user's role (Reporter, Safety Officer, Admin).
 * User-specific data is secured using an ownership model. Global roles are determined by membership in dedicated collections (roles_admin, roles_safety_officer).
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, where {userId} matches the Firebase Auth UID.
 * - /users/{userId}/reports/{reportId}: Stores reports submitted by a user.
 * - /corrective_actions/{correctiveActionId}: Stores corrective actions, with a 'reportId' field linking them to reports.
 * - /audit_logs/{auditLogId}: Stores audit logs.
 * - /roles_admin/{userId}: Collection of admin user IDs.
 * - /roles_safety_officer/{userId}: Collection of safety officer user IDs.
 *
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - Admin and Safety Officer roles are managed through existence in dedicated collections, simplifying rule logic and improving performance.
 * - Authorization Independence is achieved by including necessary authorization data (like reportId) directly on the documents being secured.
 *
 * Denormalization for Authorization:
 *  - The `corrective_actions` collection does not require retrieving associated `report` objects to authorize `read` or `write` requests.
 *
 * Structural Segregation:
 *  - User-specific reports are stored in a subcollection under `/users/{userId}/reports/{reportId}` enabling efficient, owner-only queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource based on the provided userId.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the resource.
     * @param {string} userId - The user ID to compare against the resource's data.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'admin' role.
     * @returns {boolean} True if the user has the admin role, false otherwise.
     */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with matching userId can create their profile.
     * @allow (get) Any signed-in user can read a user profile.
     * @deny (update) Non-admin cannot update.
     * @deny (delete) Non-admin cannot delete.
     * @principle Enforces user ownership for profile creation and admin-only updates.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false; // Prevent listing all users.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update, delete: if isAdmin();
    }

    /**
     * @description Rules for reports submitted by a specific user.
     * @path /users/{userId}/reports/{reportId}
     * @allow (create) User with matching userId can create a report under their profile.
     * @allow (get) User with matching userId can read their reports.
     * @deny (update) Only the owner can update their report.
     * @deny (delete) Only the owner can delete their report.
     * @principle Enforces document ownership for writes within a user's data tree.
     */
    match /users/{userId}/reports/{reportId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.reporterId == userId;
      allow update: if isExistingOwner(userId) && resource.data.reporterId == userId;
      allow delete: if isExistingOwner(userId) && resource.data.reporterId == userId;
    }

    /**
     * @description Rules for corrective actions.
     * @path /corrective_actions/{correctiveActionId}
     * @allow (get) Any signed-in user can get a corrective action.
     * @allow (create) Any signed-in user can create a corrective action.
     * @allow (update) Any signed-in user can update a corrective action.
     * @allow (delete) Any signed-in user can delete a corrective action.
     * @principle Allows read/write for all signed-in users.
     */
    match /corrective_actions/{correctiveActionId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for audit logs.
     * @path /audit_logs/{auditLogId}
     * @allow (get) Only admins can read audit logs.
     * @deny (create) Non-admins cannot create audit logs.
     * @deny (update) Non-admins cannot update audit logs.
     * @deny (delete) Non-admins cannot delete audit logs.
     * @principle Restricts access to audit logs to admin users only.
     */
    match /audit_logs/{auditLogId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for admin role assignments.
     * @path /roles_admin/{userId}
     * @allow (create) Only admins can assign the admin role to other users.
     * @deny (get) Non-admins cannot read the admin role assignments.
     * @deny (update) Non-admins cannot update admin role assignments.
     * @deny (delete) Non-admins cannot delete admin role assignments.
     * @principle Only admins can manage admin role assignments.
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if isAdmin();
    }

    /**
     * @description Rules for safety officer role assignments.
     * @path /roles_safety_officer/{userId}
     * @allow (create) Only admins can assign the safety officer role to other users.
     * @deny (get) Non-admins cannot read the safety officer role assignments.
     * @deny (update) Non-admins cannot update safety officer role assignments.
     * @deny (delete) Non-admins cannot delete safety officer role assignments.
     * @principle Only admins can manage safety officer role assignments.
     */
    match /roles_safety_officer/{userId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if isAdmin();
    }
  }
}